<%- include('../partials/header') %>

<div class="row mb-4">
    <div class="col-md-12 d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-bell"></i> Mes notifications</h2>
        <button class="btn btn-primary" id="markAllReadBtn">
            <i class="bi bi-check-all"></i> Tout marquer comme lu
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div id="notificationsContainer">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Charger toutes les notifications
    function loadAllNotifications() {
        fetch('/notifications/all')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('notificationsContainer');
                if (data.success && data.notifications.length > 0) {
                    let html = '<div class="list-group">';
                    data.notifications.forEach(notif => {
                        const date = new Date(notif.created_at);
                        const isRead = notif.lu ? 'list-group-item-light' : '';
                        html += `
                            <a href="${notif.lien || '#'}" class="list-group-item list-group-item-action ${isRead}" data-id="${notif.id}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${notif.titre}</h5>
                                    <small>${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR')}</small>
                                </div>
                                <p class="mb-1">${notif.message}</p>
                                ${!notif.lu ? '<small class="badge bg-primary">Nouveau</small>' : ''}
                            </a>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;

                    // Marquer comme lu au clic
                    container.querySelectorAll('a[data-id]').forEach(link => {
                        link.addEventListener('click', function() {
                            const notificationId = this.dataset.id;
                            fetch(`/notifications/read/${notificationId}`, { method: 'POST' })
                                .then(response => response.json());
                        });
                    });
                } else {
                    container.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Aucune notification</div>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('notificationsContainer').innerHTML = '<div class="alert alert-danger">Erreur lors du chargement</div>';
            });
    }

    // Marquer toutes comme lues
    document.getElementById('markAllReadBtn').addEventListener('click', function() {
        fetch('/notifications/read-all', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAllNotifications();
                }
            });
    });

    // Charger au d√©marrage
    loadAllNotifications();
</script>

<%- include('../partials/footer') %>

